<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>PlexAuth — Linking…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:#0f172a;color:#e2e8f0;margin:0}
    .wrap{max-width:720px;margin:6rem auto;padding:2rem;background:#111827;border-radius:16px;border:1px solid #1f2937}
    h2{margin:0 0 1rem}
    .muted{color:#94a3b8}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:2rem;background:#0b1220;padding:.4rem .8rem;border-radius:10px;border:1px solid #334155;letter-spacing:.08em}
    a,button{color:#e2e8f0}
    .btn{display:inline-block;padding:.6rem .9rem;border:1px solid #334155;border-radius:10px;background:#0b1220;text-decoration:none;cursor:pointer}
    .row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .ok{color:#86efac}
    .warn{color:#fbbf24}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Complete sign-in</h2>
    <p class="muted">We opened the Plex link page in a new tab and copied your code to the clipboard.</p>
    <p>Enter this code:</p>
    <p class="code" id="code">{{ .Code }}</p>
    <div class="row">
      <a id="openLink" class="btn" href="https://plex.tv/link" target="_blank" rel="noopener">Open plex.tv/link</a>
      <button id="copyBtn" class="btn" type="button">Copy code</button>
    </div>
    <p id="status" class="muted" style="margin-top:1rem">Waiting for you to complete linking in Plex…</p>
  </div>

  <script>
    (function(){
      const code = "{{ .Code }}";
      const base = "{{ .BaseURL }}";
      const statusEl = document.getElementById('status');

      // Try to open plex.tv/link automatically (may be blocked by popup settings)
      try { window.open("https://plex.tv/link", "_blank", "noopener"); } catch(e){}

      // Auto-copy the code (best effort)
      async function copyCode() {
        try {
          await navigator.clipboard.writeText(code);
          statusEl.textContent = "Code copied to clipboard. Enter it on plex.tv/link. Waiting for confirmation…";
        } catch (e) {
          statusEl.textContent = "Please copy the code and enter it on plex.tv/link. Waiting for confirmation…";
        }
      }
      copyCode();

      // Manual copy fallback button
      document.getElementById('copyBtn').addEventListener('click', copyCode);

      // Poll our server every 2s to see if the token is ready.
      let timer = setInterval(async () => {
        try {
          const res = await fetch(`${base}/auth/poll/${code}`, { credentials: 'include' });
          if (res.status === 200) {
            clearInterval(timer);
            statusEl.innerHTML = "<span class='ok'>Linked! Redirecting to portal…</span>";
            // Session cookie is set by the server; now go to the portal.
            setTimeout(() => { window.location = `${base}/portal`; }, 500);
          } else if (res.status === 202) {
            // still pending; keep waiting
          } else if (res.status === 404) {
            statusEl.innerHTML = "<span class='warn'>Code not found or expired. Go back and try again.</span>";
          } else {
            // some other error
            statusEl.innerHTML = "<span class='warn'>Temporary error. Still waiting…</span>";
          }
        } catch (e) {
          // network hiccup, keep polling
        }
      }, 2000);
    })();
  </script>
</body>
</html>